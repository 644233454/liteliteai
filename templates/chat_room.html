<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" name="viewport" content="width=device-width,initial-scale=1.0">
    <title>LiteLiteAI</title>
    <link rel="stylesheet" href="../static/css/marked.css">

    <link rel="shortcut icon" href="../static/favicon.ico" type="image/x-icon">
</head>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-12">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col">
                            <h5 class="mb-0">{{ chat_room.chat_title }}</h5>
                        </div>
                        <div class="col-auto">
                            <a href="{{ url_for('index.chat_rooms') }}" class="btn btn-outline-secondary">
                                返回聊天室列表
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="conversation">
                        {% for message in messages %}
                            {#                            <div class="old-msg">#}
                            {% if message.role == 'user' %}
                                <div class="message mine">我： {{ message.content | safe }}</div>

                            {% else %}
                                <div class="message botmsg">Bot: {{ message.content | safe }}</div>
                            {% endif %}
                            {#                            </div>#}
                        {% endfor %}
                        <div id="last-message"></div>
                    </div>
                    <form>
                        <div class="form-group">
                            <input type="text" id="message" class="form-control" placeholder="Type your message">
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                    </form>
                </div>
                <div class="card-body">
                    <div class="col-auto">
                        <a href="{{ url_for('index.chat_rooms') }}" class="btn btn-outline-secondary">
                            返回聊天室列表
                        </a>
                    </div>
                </div>
                {#                <div class="card-body">#}
                {#                    <button id="recordButton" type="button">Record</button>#}
                {#                    <button id="stopButton" type="button" disabled>Stop</button>#}
                {#                </div>#}

            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/atom-one-dark.min.css">
<script src="../static/js/marked.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/mic-recorder-to-mp3@2.2.1/dist/index.min.js"></script>

<script>
    var renderer = new marked.Renderer();
    renderer.code = function (code, language) {
        var hlCode = language ? hljs.highlight(language, code) : hljs.highlightAuto(code);
        return '<pre><code class="hljs ' + language + '">' + hlCode.value + '</code></pre>';
    };
    marked.setOptions({
        renderer: renderer
    });
    document.querySelectorAll('.botmsg').forEach((box) => {
        box.innerHTML = marked.parse(box.innerHTML)
    });
    hljs.highlightAll();

    function addMessage(message, className) {
        var conversation = document.getElementById('conversation');
        var div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(className);
        var isBot = className == "botmsg";
        div.innerHTML = isBot ? marked.parse(message) : message;
        conversation.appendChild(div);
        document.querySelectorAll('code').forEach((code) => {
           hljs.highlightBlock(code);
        });
        {#hljs.highlightBlock(div)#}
        {#if (isBot) {#}
        {#    div.querySelectorAll('pre code').forEach((block) => {#}
        {#        var copyBtn = document.createElement('button');#}
        {#        copyBtn.className = 'btn btn-sm btn-outline-secondary copy-button';#}
        {#        copyBtn.textContent = 'Copy';#}
        {#        copyBtn.addEventListener('click', function () {#}
        {#            navigator.clipboard.writeText(block.textContent)#}
        {#                .then(() => {#}
        {#                    console.log('Text copied to clipboard');#}
        {#                    copyBtn.textContent = 'Copied!';#}
        {#                    setTimeout(function () {#}
        {#                        copyBtn.textContent = 'Copy';#}
        {#                    }, 2000);#}
        {#                })#}
        {#                .catch(err => {#}
        {#                    console.error('Error in copying text: ', err);#}
        {#                });#}
        {##}
        {#        });#}
        {#        block.parentNode.insertBefore(copyBtn, block.nextSibling);#}
        {#    });#}
        {#}#}

        }

        function showLoading() {
            var conversation = document.getElementById('conversation');
            var div = document.createElement('div');
            div.classList.add('loading');
            conversation.appendChild(div);
        }

        function hideLoading() {
            var conversation = document.getElementById('conversation');
            var div = conversation.querySelector('.loading');
            if (div) {
                conversation.removeChild(div);
            }
        }

        function sendMessage(event) {
            event.preventDefault();
            var msg = document.getElementById('message').value;
            var chat_id = "{{ chat_room.chat_id }}";
            if (msg.trim() === '') {
                return;
            }
            addMessage('我：' + msg, 'mine');
            showLoading();
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    hideLoading();
                    if (xhr.status === 200) {
                        if (xhr.responseText) {
                            addMessage('Bot：' + xhr.responseText, 'botmsg');
                        }
                    } else {
                        addMessage('Error: ' + xhr.status, 'botmsg');
                    }
                }
            };
            xhr.open('POST', '/chat', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                'msg': msg,
                'chat_id': chat_id
            }));
            document.getElementById('message').value = '';
        }

        var form = document.querySelector('form');
        form.addEventListener('submit', sendMessage);

        window.scrollTo(0, document.body.scrollHeight);

</script>
<script>
    {#function upload(blob) {#}
    {#    var formData = new FormData();#}
    {#    formData.append('file', blob, 'audio.mp3');#}
    {##}
    {#    var xhr = new XMLHttpRequest();#}
    {#    xhr.open('POST', '/voice', true);#}
    {#    xhr.onreadystatechange = function () {#}
    {#        if (xhr.readyState == 4 && xhr.status == 200) {#}
    {#            console.log(xhr.responseText);#}
    {#        }#}
    {#    };#}
    {#    xhr.send(formData);#}
    {#}#}
        {##}
        {#const button = document.querySelector('button');#}
        {#const button = document.getElementById('recordButton');#}
        {#var stopButton = document.getElementById('stopButton');#}
        {#const recorder = new MicRecorder({#}
        {#    bitRate: 128#}
        {#})
            ;
            #}
            {##}
            {#button.addEventListener('click', startRecording);#}
            {##}
            {#function startRecording() {#}
            {#    recorder.start().then(() => {#}
            {#        button.textContent = 'Stop recording';#}
            {#        button.classList.toggle('btn-danger');#}
            {#        button.removeEventListener('click', startRecording);#}
            {#        button.addEventListener('click', stopRecording);#}
            {#    }).catch((e) => {#}
            {#        alert(e);#}
            {#        console.error(e);#}
            {#    });#}
            {#}#}
                {##}
                {#function stopRecording() {#}
                {#    recorder.stop().getMp3().then(([buffer, blob]) => {#}
                {#        console.log(buffer, blob);#}
                {#        const file = new File(buffer, 'music.mp3', {#}
                {#            type: blob.type,#}
                {#            lastModified: Date.now()#}
                {#        });#}
                {##}
                {#        const li = document.createElement('li');#}
                {#        const player = new Audio(URL.createObjectURL(file));#}
                {#        player.controls = true;#}
                {#        li.appendChild(player);#}
                {#        document.querySelector('#playlist').appendChild(li);#}
                {##}
                {#        button.textContent = 'Start recording';#}
                {#        button.classList.toggle('btn-danger');#}
                {#        button.removeEventListener('click', stopRecording);#}
                {#        button.addEventListener('click', startRecording);#}
                {#        upload(blob);#}
                {#    }).catch((e) => {#}
                {#        console.error(e);#}
                {#    });#}
                {
    #}#}
</script>
</body>
</html>
